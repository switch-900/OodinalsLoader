<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oodianls Loader - Simple Example</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 40px auto; padding: 0 16px; max-width: 820px; }
    h1 { margin: 0 0 6px 0; font-size: 22px; }
    .sub { margin: 0 0 18px 0; color: #555; font-size: 13px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button { border: 1px solid #ddd; background: #111; color: #fff; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 700; }
    button.secondary { background: #fff; color: #111; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    textarea { width: 100%; height: 280px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin: 12px 0; }
    pre { white-space: pre-wrap; word-break: break-word; background: #f6f6f6; border: 1px solid #e7e7e7; padding: 12px; border-radius: 10px; margin: 12px 0 0 0; }
    .muted { color: #666; font-size: 12px; }
    .pill { display: inline-flex; align-items: center; gap: 8px; background: #f6f6f6; border: 1px solid #e7e7e7; padding: 8px 10px; border-radius: 999px; font-size: 12px; }
    .ok { color: #0a7a2f; }
    .bad { color: #b00020; }
  </style>
</head>
<body>
  <h1>Oodianls — Simple Demo</h1>
  <p class="sub">An <strong>Oodianal</strong> is an inscription that can create other inscriptions. This demo loads the Loader, connects a wallet, estimates fees, and creates an inscription.</p>

  <div class="row">
    <button id="connectBtn" disabled>Connect Wallet</button>
    <button id="disconnectBtn" class="secondary" style="display:none">Disconnect</button>
    <span id="walletPill" class="pill"><span id="loaderDot" class="bad">●</span><span id="walletHint">Loading Nexus Loader…</span></span>
  </div>

  <div id="walletInfo" class="muted" style="display:none; margin-top:10px">
    Connected: <span id="walletType"></span> — <span id="walletAddress"></span>
  </div>

  <h3 style="margin:18px 0 6px 0">JSON</h3>
  <div class="muted">Paste your inscription JSON config:</div>

  <textarea id="jsonConfig">{
  "version": 1,
  "feeRate": 10,
  "fees": {
    "developer": {
      "enabled": false
    },
    "customFees": []
  },
  "defaults": {
    "contentType": "text/plain",
    "metaprotocol": "",
    "metadata": {
      "app": "oodianls"
    },
    "properties": {
      "collection": "Test"
    },
    "postage": 546
  },
  "items": [
    {
      "fileName": "hello.txt",
      "content": "Hello Bitcoin!",
      "repeatCount": 1
    }
  ]
}</textarea>

  <div class="row">
    <button id="estimateBtn" class="secondary" disabled>Estimate Fees</button>
    <button id="createBtn" disabled>Create Inscription</button>
  </div>

  <pre id="status" class="muted">Ready.</pre>

  <!-- Wallet Picker Modal (simple, no dependencies) -->
  <div id="walletModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:99999">
    <div style="width:min(560px,92vw);background:#fff;border-radius:14px;box-shadow:0 18px 60px rgba(0,0,0,.35);padding:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div style="font-size:16px;font-weight:900;color:#111">Select Wallet</div>
        <button id="walletModalClose" class="secondary" style="background:#fff;color:#111">Close</button>
      </div>
      <div id="walletModalHint" class="muted" style="margin-bottom:10px"></div>
      <div id="walletList" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
    </div>
  </div>

  <!-- ONE LINE - Load Nexus Loader -->
  <script type="module">
    // One-line import (proxy-safe):
    const mod = await import('/r/sat/404079598183801/at/-1/content');
    window.Nexus = mod.default;

    const ALL_WALLETS = [
      { id: 'bitmapwallet', name: 'BitmapWallet' },
      { id: 'unisat', name: 'UniSat' },
      { id: 'xverse', name: 'Xverse' },
      { id: 'okx', name: 'OKX' },
      { id: 'leather', name: 'Leather' },
      { id: 'phantom', name: 'Phantom' },
      { id: 'wizz', name: 'Wizz' },
      { id: 'magiceden', name: 'Magic Eden' },
      { id: 'oyl', name: 'Oyl' }
    ];

    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const estimateBtn = document.getElementById('estimateBtn');
    const createBtn = document.getElementById('createBtn');
    const hintEl = document.getElementById('walletHint');
    const dotEl = document.getElementById('loaderDot');

    function setHint(text, ok) {
      if (hintEl) hintEl.textContent = text || '';
      if (dotEl) dotEl.className = ok ? 'ok' : 'bad';
    }

    function setStatus(obj) {
      const el = document.getElementById('status');
      if (!el) return;
      if (typeof obj === 'string') el.textContent = obj;
      else el.textContent = JSON.stringify(obj, null, 2);
    }

    function getInstalledWalletsSafe() {
      try {
        if (window.Nexus && typeof window.Nexus.getInstalledWallets === 'function') {
          return window.Nexus.getInstalledWallets() || [];
        }
      } catch {}
      return [];
    }

    function setModalOpen(isOpen) {
      const modal = document.getElementById('walletModal');
      if (!modal) return;
      modal.style.display = isOpen ? 'flex' : 'none';
    }

    function renderWalletModal() {
      const list = document.getElementById('walletList');
      const hint = document.getElementById('walletModalHint');
      if (!list) return;
      list.innerHTML = '';

      const installed = getInstalledWalletsSafe();
      const installedSet = new Set(installed.map(w => w.id));
      const hasInstallInfo = installed.length > 0;

      if (hint) {
        hint.textContent = hasInstallInfo
          ? `Installed: ${installed.map(w => w.name).join(', ')}`
          : 'Wallet detection unavailable. Try clicking your wallet anyway.';
      }

      // Sort: installed wallets first, then alpha
      const ordered = ALL_WALLETS.slice().sort((a, b) => {
        const aIns = installedSet.has(a.id);
        const bIns = installedSet.has(b.id);
        if (aIns !== bIns) return aIns ? -1 : 1;
        return a.name.localeCompare(b.name);
      });

      for (const w of ordered) {
        const isInstalled = installedSet.has(w.id);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = hasInstallInfo && !isInstalled ? `${w.name} (not installed)` : w.name;
        btn.disabled = hasInstallInfo && !isInstalled;
        btn.style.cssText = [
          'text-align:left',
          'background:' + (btn.disabled ? '#f2f2f2' : '#111'),
          'color:' + (btn.disabled ? '#777' : '#fff'),
          'border:1px solid ' + (btn.disabled ? '#eee' : '#111'),
          'padding:12px 12px',
          'border-radius:10px',
          'cursor:' + (btn.disabled ? 'not-allowed' : 'pointer'),
          'font-weight:700',
          'box-shadow:' + (btn.disabled ? 'none' : '0 10px 22px rgba(0,0,0,.12)')
        ].join(';');
        btn.onclick = async () => {
          if (btn.disabled) return;
          setModalOpen(false);
          await connectWallet(w.id);
        };
        list.appendChild(btn);
      }
    }

    function openWalletModal() {
      // Open first so the user gets immediate feedback.
      setModalOpen(true);
      try {
        renderWalletModal();
      } catch (e) {
        // If something unexpected happens, keep modal open and show an error.
        const hint = document.getElementById('walletModalHint');
        if (hint) hint.textContent = 'Unable to list wallets. See console for details.';
        console.error(e);
      }
    }

    window.openWalletModal = openWalletModal;
    document.getElementById('connectBtn')?.addEventListener('click', openWalletModal);

    // Close modal behavior
    document.getElementById('walletModalClose')?.addEventListener('click', () => setModalOpen(false));
    document.getElementById('walletModal')?.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'walletModal') setModalOpen(false);
    });

    // Initial UI enable after loader ready
    if (connectBtn) connectBtn.disabled = false;
    setHint('Click Connect Wallet to choose (no auto-connect).', true);

    async function connectWallet(walletId) {
      try {
        if (connectBtn) connectBtn.disabled = true;
        setStatus(`Connecting to ${walletId}...`);
        
        const wallet = await window.Nexus.connectWallet(walletId);
        
        document.getElementById('walletInfo').style.display = 'block';
        document.getElementById('walletType').textContent = walletId;
        document.getElementById('walletAddress').textContent = wallet.address;
        document.getElementById('connectBtn').style.display = 'none';
        document.getElementById('disconnectBtn').style.display = 'inline-block';
        if (createBtn) createBtn.disabled = false;
        if (estimateBtn) estimateBtn.disabled = false;
        setHint(`Connected: ${walletId}`, true);
        
        setStatus({ connected: true, walletId, address: wallet.address });
      } catch (error) {
        if (connectBtn) connectBtn.disabled = false;
        setHint('Connection failed. Try again.', false);
        setStatus({ error: error?.message || String(error) });
      }
    }

    window.disconnect = async function() {
      try {
        if (disconnectBtn) disconnectBtn.disabled = true;
        setStatus('Disconnecting...');
        await window.Nexus.disconnect();
        
        document.getElementById('walletInfo').style.display = 'none';
        document.getElementById('connectBtn').style.display = 'inline-block';
        document.getElementById('disconnectBtn').style.display = 'none';
        if (createBtn) createBtn.disabled = true;
        if (estimateBtn) estimateBtn.disabled = true;
        if (connectBtn) connectBtn.disabled = false;
        
        setHint('Disconnected. Click Connect Wallet.', true);
        setStatus('Disconnected.');
      } catch (error) {
        setHint('Disconnect failed.', false);
        setStatus({ error: error?.message || String(error) });
      } finally {
        if (disconnectBtn) disconnectBtn.disabled = false;
      }
    };

    disconnectBtn?.addEventListener('click', () => window.disconnect());

    window.estimateFees = async function() {
      try {
        const jsonText = document.getElementById('jsonConfig').value;
        
        if (estimateBtn) estimateBtn.disabled = true;
        setStatus('Estimating fees...');
        const fees = await window.Nexus.estimateFees(jsonText);

        setStatus(fees);
      } catch (error) {
        setStatus({ error: error?.message || String(error) });
      } finally {
        if (estimateBtn) estimateBtn.disabled = false;
      }
    };

    window.createInscription = async function() {
      try {
        const jsonText = document.getElementById('jsonConfig').value;
        
        if (createBtn) createBtn.disabled = true;
        setStatus('Creating inscription... approve in your wallet.');
        const result = await window.Nexus.createInscription(jsonText);

        // Keep output proxy-safe: no hardcoded explorer URLs.
        setStatus(result);
      } catch (error) {
        setStatus({ error: error?.message || String(error) });
      } finally {
        if (createBtn) createBtn.disabled = false;
      }
    };

    estimateBtn?.addEventListener('click', () => window.estimateFees());
    createBtn?.addEventListener('click', () => window.createInscription());
  </script>
</body>
</html>
